<div *ngIf="loading">Loading...</div>

<div *ngIf="!loading">
  <div
    infiniteScroll
    [infiniteScrollDistance]="2"
    [infiniteScrollThrottle]="150"
    (scrolled)="loadMore()"
  >
    <div class="bragcard" *ngFor="let item of visibleBragItems; let i = index">
      <section class="bragcard-top" [ngClass]="'bg-primary0' + ((i % 6) + 1)">
        <article [ngClass]="'bg-overlay0' + ((i % 6) + 1)">
          <h2 class="bragcard-title">
            <span class="bigger">Brag</span>:
            <span class="smaller">{{ item.rider }} just rode in {{ item.location }}</span>
          </h2>
        </article>
      </section>

      <section class="bragcard-parallax parallax" [style.--parallax-bg]="'url(' + item.image + ')'">
        <article class="bragcard-article-wrapper" style="position: relative">
          <button
            class="toggle-article-btn"
            [ngClass]="'bg-primary0' + ((i % 6) + 1)"
            (click)="toggleArticle(i)"
            aria-label="Hide/Show"
          >
            <i class="fa-solid" [ngClass]="hideArticle[i] ? 'fa-arrow-down' : 'fa-arrow-up'"></i>
            <span style="margin-left: 8px;">
              {{ hideArticle[i] ? 'See Brag' : 'See Picture' }}
            </span>
          </button>
          <div
            class="bragcard-article-content"
            [ngClass]="[
              'bg-overlay0' + ((i % 6) + 1),
              hideArticle[i] ? 'slide-out-up' : 'slide-in-down',
            ]"
          >
            <div class="bragcard-map-block" [innerHTML]="item.map">
            </div>

            <div class="bragcard-quote-block">
              <div class="bragcard-date">
                <strong>{{ item.date }}</strong>
              </div>

              <div class="bragcard-quote" *ngIf="item.description">
                <i class="fa-solid fa-quote-left"></i>
                {{ item.description }}
                <div class="bragcard-rider fa-quoteby" *ngIf="item.rider">
                -
                  <a href="#" (click)="filterByRider(item.rider!); $event.preventDefault()">{{
                    item.rider
                  }}</a>
                  <button
                    *ngIf="filteredRider"
                    (click)="filteredRider = null"
                    class="clear-rider-filter-btn"
                  >
                    Clear Rider Filter
                  </button>
                </div>
              </div>

              <div class="bragcard-tipcard" *ngIf="item.tips && item.tips.trim()">
                <i
                  class="bragcard-askbrag-icon fas fa-comments"
                  title="Ask about biking here"
                  (click)="openAssistantModal(item.location)">
                </i>

                <app-modal
                  *ngIf="showChatModal"
                  [title]="'Ask BRAG about biking in ' + chatSession.location"
                  (closed)="showChatModal = false"
                >
                  <div class="chat-window">
                    <div *ngFor="let msg of chatSession.messages" class="chat-bubble">{{ msg }}</div>
                    <input [(ngModel)]="userMessage" placeholder="Type your question..." />
                    <button (click)="sendMessage()">Send</button>
                  </div>
                </app-modal>

                <h3><span class="bigger">Brag's</span> Tips for {{ item.location }}</h3>

                <ul [innerHTML]="item.tips"></ul>
              </div>

              <div class="bragcard-tags" *ngIf="item.tags">
                <strong>Tags:</strong>
                <ng-container *ngFor="let tag of item.tags.split(',')">
                  <a href="#" (click)="filterByTag(tag.trim()); $event.preventDefault()">{{
                    tag.trim()
                  }}</a>
                  <span *ngIf="tag !== item.tags.split(',')[item.tags.split(',').length - 1]"
                    >,
                  </span>
                </ng-container>
                <button
                  *ngIf="filteredTag"
                  (click)="filteredTag = null"
                  class="clear-tag-filter-btn"
                >
                  Clear Tag Filter
                </button>
              </div>
            </div>
          </div>
          <!-- Close bragcard-article-content -->
        </article>
        <!-- Close bragcard-article-wrapper -->
      </section>
    </div>
  </div>
</div>
